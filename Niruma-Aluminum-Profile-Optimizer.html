<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Niruma Aluminum Profile Optimizer</title>
    <style>
        /* [Previous CSS styles remain exactly the same] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .header p { font-size: 16px; opacity: 0.9; }
        .tabs { display: flex; background: #ecf0f1; border-bottom: 3px solid #3498db; overflow-x: auto; }
        .tab { flex: 1; min-width: 150px; padding: 15px 10px; text-align: center; cursor: pointer; background: #ecf0f1; border: none; font-size: 14px; font-weight: 600; transition: all 0.3s; white-space: nowrap; }
        .tab:hover { background: #d5dbdb; }
        .tab.active { background: white; color: #3498db; }
        .tab-content { display: none; padding: 30px; max-height: calc(100vh - 300px); overflow-y: auto; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 8px; font-size: 14px; transition: border 0.3s; }
        .form-group textarea { min-height: 80px; font-family: monospace; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin: 5px; }
        .btn-primary { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); }
        .btn-success { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; }
        .btn-sm { padding: 8px 15px; font-size: 12px; }
        .window-list { margin-top: 20px; }
        .window-card { background: #f8f9fa; border-left: 4px solid #3498db; padding: 20px; margin-bottom: 15px; border-radius: 8px; }
        .window-card h3 { color: #2c3e50; margin-bottom: 10px; }
        .window-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px; color: #555; }
        .window-actions { margin-top: 15px; display: flex; gap: 10px; }
        .formula-card { background: #ffffff; border: 2px solid #3498db; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .formula-card h3 { color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .formula-item { background: #f8f9fa; padding: 12px; margin: 8px 0; border-radius: 5px; border-left: 3px solid #27ae60; display: flex; justify-content: space-between; align-items: start; }
        .formula-content { flex: 1; }
        .formula-item strong { color: #2c3e50; }
        .formula-item code { background: #ecf0f1; padding: 2px 6px; border-radius: 3px; font-family: monospace; color: #e74c3c; }
        .formula-actions { display: flex; gap: 5px; }
        .stock-material-card { background: #f8f9fa; border: 2px solid #95a5a6; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .stock-material-card h4 { color: #2c3e50; margin-bottom: 10px; }
        .results-section { background: #f8f9fa; padding: 25px; border-radius: 8px; margin-bottom: 25px; }
        .results-section h2 { color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #3498db; }
        .material-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .material-section h3 { color: #27ae60; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        table th { background: #34495e; color: white; padding: 12px; text-align: left; font-weight: 600; }
        table td { padding: 12px; border-bottom: 1px solid #dfe6e9; }
        table tr:hover { background: #f8f9fa; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-card h4 { font-size: 14px; opacity: 0.9; margin-bottom: 10px; }
        .stat-card p { font-size: 28px; font-weight: 700; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .alert-info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .project-selector { background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107; }
        .section-header { background: #34495e; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #dfe6e9; }
        .modal-header h3 { color: #2c3e50; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #95a5a6; }
        .close-btn:hover { color: #e74c3c; }
        .optimization-mode { background: #e8f5e9; border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .unit-toggle { background: #3498db; color: white; padding: 10px 20px; border-radius: 8px; margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .unit-toggle label { margin: 0; font-weight: 600; }
        .unit-switch { position: relative; display: inline-block; width: 60px; height: 30px; }
        .unit-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #2c3e50; transition: .4s; border-radius: 30px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #27ae60; }
        input:checked + .slider:before { transform: translateX(30px); }
        .cutting-diagram { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db; }
        .cost-breakdown-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin: 15px 0; }
        .cost-breakdown-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .import-export-section { background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        @media print { body * { visibility: hidden; } .label-grid, .label-grid * { visibility: visible; } .label-grid { position: absolute; left: 0; top: 0; } }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è Niruma Aluminum Profile Optimizer</h1>
            <p>Intelligent Cutting with Cost-Aware Algorithm</p>
        <div class="unit-toggle">
            <label>Input Unit:</label>
            <span><strong class="unit-label">inches</strong></span>
            <label class="unit-switch">
                <input type="checkbox" id="unitToggle" onchange="toggleUnit()">
                <span class="slider"></span>
            </label>
            <span><strong class="unit-label">mm</strong></span>
        </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('input')">üìù Add Windows</button>
            <button class="tab" onclick="showTab('windows')">ü™ü Window List</button>
            <button class="tab" onclick="showTab('formulas')">üßÆ Series Formulas</button>
            <button class="tab" onclick="showTab('stock')">üì¶ Stock Master</button>
            <button class="tab" onclick="showTab('optimize')">‚öôÔ∏è Optimize</button>
            <button class="tab" onclick="showTab('results')">üìä Results</button>
        </div>

        <div id="input" class="tab-content active">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">Add Window Configuration</h2>
            <form id="windowForm" onsubmit="addWindow(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Config ID</label>
                        <input type="text" id="configId" value="W01" required>
                    </div>
                    <div class="form-group">
                        <label>Project Name</label>
                        <input type="text" id="projectName" value="check" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Width <span class="unit-label">(inches)</span></label>
                        <input type="number" id="width" step="0.25" value="65" required>
                    </div>
                    <div class="form-group">
                        <label>Height <span class="unit-label">(inches)</span></label>
                        <input type="number" id="height" step="0.25" value="56" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tracks</label>
                        <select id="tracks" required>
                            <option value="2">2 Tracks</option>
                            <option value="3" selected>3 Tracks</option>
                            <option value="4">4 Tracks</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Glass Shutters (S)</label>
                        <select id="shutters" required>
                            <option value="1">1 Shutter</option>
                            <option value="2">2 Shutters</option>
                            <option value="3" selected>3 Shutters</option>
                            <option value="4">4 Shutters</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mosquito Shutters (MS)</label>
                        <select id="mosquitoShutters" required>
                            <option value="0" selected>0 Mosquito Shutter</option>
                            <option value="1">1 Mosquito Shutter</option>
                            <option value="2">2 Mosquito Shutters</option>
                            <option value="3">3 Mosquito Shutters</option>
                            <option value="4">4 Mosquito Shutters</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Series Type</label>
                        <select id="series" required></select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="description" value="Living Room" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">‚ûï Add Window</button>
                <button type="button" class="btn btn-danger" onclick="clearForm()">üîÑ Clear Form</button>
            </form>
        </div>

        <div id="windows" class="tab-content">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">Window Configurations</h2>
            <div id="windowList" class="window-list"></div>
        </div>

        <div id="formulas" class="tab-content">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">Series Formulas Configuration</h2>
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Formula Variables:</strong> W = Width, H = Height, S = Shutters, T = Tracks, MS = Mosquito Shutters
            </div>
            <div id="formulasList"></div>
            <div class="section-header">
                <h3>‚ûï Add New Series / Component</h3>
            </div>
            <form id="newSeriesForm" onsubmit="addNewSeries(event)">
                <div class="form-group">
                    <label>Series Name</label>
                    <input type="text" id="newSeriesName" placeholder="e.g., 1.5" required>
                </div>
                <div class="form-group">
                    <label>Component Name</label>
                    <input type="text" id="newComponentName" placeholder="e.g., 1.5 Handle" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="newComponentDesc" placeholder="e.g., Handles" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantity Formula</label>
                        <input type="text" id="newQtyFormula" placeholder="e.g., 2 or 2*S" required>
                    </div>
                    <div class="form-group">
                        <label>Length Formula</label>
                        <input type="text" id="newLengthFormula" placeholder="e.g., H-1.5" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">‚ûï Add Component</button>
            </form>
        </div>

        <div id="stock" class="tab-content">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">Stock Master Configuration</h2>
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Configure Stock:</strong> Set lengths and costs for optimization
            </div>
            <div class="form-group" style="max-width: 300px;">
                <label>Kerf - Saw Blade Width <span class="unit-label">(inches)</span></label>
                <input type="number" id="kerfGlobal" value="0.125" step="0.001" onchange="updateKerf()">
            </div>
            <div id="stockMasterList"></div>
            <div class="section-header">
                <h3>‚ûï Add New Stock Material</h3>
            </div>
            <form id="newStockForm" onsubmit="addNewStock(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Series</label>
                        <select id="newStockSeries" required></select>
                    </div>
                    <div class="form-group">
                        <label>Material Name</label>
                        <input type="text" id="newStockMaterial" placeholder="e.g., Domal Shutter" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Stock 1 Length <span class="unit-label">(inches)</span></label>
                        <input type="number" id="newStock1" value="141" step="1" required>
                    </div>
                    <div class="form-group">
                        <label>Stock 1 Cost (‚Çπ)</label>
                        <input type="number" id="newStock1Cost" value="100" step="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Stock 2 Length <span class="unit-label">(inches)</span></label>
                        <input type="number" id="newStock2" value="177" step="1" required>
                    </div>
                    <div class="form-group">
                        <label>Stock 2 Cost (‚Çπ)</label>
                        <input type="number" id="newStock2Cost" value="125" step="1">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">‚ûï Add Stock Material</button>
            </form>
        </div>

        <div id="optimize" class="tab-content">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">Run Optimization</h2>
            <div class="optimization-mode">
                <h4>üí∞ Smart Cost Optimization Enabled</h4>
                <p style="margin: 0; color: #555;">
                    ‚úÖ Minimizes material waste<br>
                    ‚úÖ Prefers cost-effective stock combinations<br>
                    ‚úÖ Considers total project cost
                </p>
            </div>
            <div class="project-selector">
                <h3 style="margin-bottom: 15px;">Select Project to Optimize</h3>
                <div class="form-group">
                    <label>Project Name</label>
                    <select id="projectSelector" style="max-width: 400px;">
                        <option value="">-- Select Project --</option>
                    </select>
                </div>
                <p style="margin-top: 10px; color: #856404;">
                    <strong>Selected Project Info:</strong> <span id="projectInfo">No project selected</span>
                </p>
            </div>
            <div style="text-align: center; padding: 40px;">
                <button class="btn btn-success" onclick="runOptimization()" style="font-size: 20px; padding: 20px 50px;">
                    üöÄ RUN SMART OPTIMIZATION
                </button>
            </div>
        </div>

        <div id="results" class="tab-content">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">Optimization Results</h2>
            <div id="resultsContent"></div>
        </div>
    </div>

    <div id="addComponentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Add New Component</h3>
                <button class="close-btn" onclick="closeAddComponentModal()">&times;</button>
            </div>
            <form id="addComponentForm" onsubmit="saveNewComponent(event)">
                <input type="hidden" id="addComponentSeries">
                <div class="form-group">
                    <label>Component Name</label>
                    <input type="text" id="modalComponentName" placeholder="e.g., Domal Handle" required>
                </div>
                <div class="form-group">
                    <label>Quantity Formula</label>
                    <input type="text" id="modalComponentQty" placeholder="e.g., 2*S or 4" required>
                    <small style="color: #7f8c8d;">Use variables: W (width), H (height), S (shutters), MS (mosquito)</small>
                </div>
                <div class="form-group">
                    <label>Length Formula</label>
                    <input type="text" id="modalComponentLength" placeholder="e.g., H-2.75 or W/2" required>
                    <small style="color: #7f8c8d;">Use variables: W (width), H (height), S (shutters)</small>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="modalComponentDesc" placeholder="e.g., Side Handle" required>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddComponentModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Component</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editWindowModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Edit Window</h3>
                <button class="close-btn" onclick="closeEditWindowModal()">&times;</button>
            </div>
            <form id="editWindowForm" onsubmit="saveWindowEdit(event)">
                <input type="hidden" id="editWindowIndex">
                <div class="form-row">
                    <div class="form-group">
                        <label>Config ID</label>
                        <input type="text" id="editConfigId" required>
                    </div>
                    <div class="form-group">
                        <label>Project Name</label>
                        <input type="text" id="editProjectName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Width <span class="unit-label">(inches)</span></label>
                        <input type="number" id="editWidth" step="0.25" required>
                    </div>
                    <div class="form-group">
                        <label>Height <span class="unit-label">(inches)</span></label>
                        <input type="number" id="editHeight" step="0.25" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tracks</label>
                        <select id="editTracks" required>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Shutters</label>
                        <select id="editShutters" required>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mosquito</label>
                        <select id="editMosquitoShutters" required>
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Series</label>
                        <select id="editSeries" required></select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="editDescription" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">üíæ Save Changes</button>
                <button type="button" class="btn btn-danger" onclick="closeEditWindowModal()">Cancel</button>
            </form>
        </div>
    </div>

    <div id="editFormulaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Edit Formula</h3>
                <button class="close-btn" onclick="closeEditFormulaModal()">&times;</button>
            </div>
            <form id="editFormulaForm" onsubmit="saveFormulaEdit(event)">
                <input type="hidden" id="editFormulaSeries">
                <input type="hidden" id="editFormulaIndex">
                <div class="form-group">
                    <label>Component Name</label>
                    <input type="text" id="editFormulaComponent" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="editFormulaDesc" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantity Formula</label>
                        <input type="text" id="editFormulaQty" required>
                    </div>
                    <div class="form-group">
                        <label>Length Formula</label>
                        <input type="text" id="editFormulaLength" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">üíæ Save Changes</button>
                <button type="button" class="btn btn-danger" onclick="closeEditFormulaModal()">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        // Global data store
        let windows = [];
        let seriesFormulas = {};
        let stockMaster = {};
        let optimizationResults = null;
        let kerf = 0.125;
        let unitMode = 'inch'; 
        const MM_TO_INCH = 0.0393701;
        const INCH_TO_MM = 25.4;

        // [Conversion functions]
        function convertToInches(value) { return unitMode === 'mm' ? value * MM_TO_INCH : value; }
        function convertFromInches(value) { return unitMode === 'mm' ? value * INCH_TO_MM : value; }

        function toggleUnit() {
            unitMode = unitMode === 'inch' ? 'mm' : 'inch';
            updateUnitLabels();
            displayWindows();
            if (optimizationResults) displayResults();
        }

        function updateUnitLabels() {
            const unit = unitMode === 'inch' ? 'inches' : 'mm';
            document.querySelectorAll('.unit-label').forEach(el => {
                if (el.tagName === 'SPAN' && el.classList.contains('unit-label')) {
                    el.textContent = '(' + unit + ')';
                } else {
                    el.textContent = unit;
                }
            });
        }

        // [Initialization Function - UPDATED LOGIC HERE]
        function initializeDefaults() {
            seriesFormulas = {
                'Domal': [
                    { component: 'Domal Shutter', qty: '2*S', length: 'H-2.75', desc: 'Shutter Vertical' },
                    { component: 'Domal Shutter', qty: '2*S', length: '(W-3+2.5*(S-1))/S', desc: 'Shutter Horizontal' },
                    { component: 'Domal Clip', qty: '2*(S-1)', length: 'H-2.75', desc: 'Domal Clip' },
                    { component: 'Domal Track', qty: '1', length: 'W', desc: 'Track Top' },
                    { component: 'Domal Track', qty: '1', length: 'W', desc: 'Track Bottom' },
                    { component: 'Domal Track', qty: '2', length: 'H', desc: 'Track Sides' },
                    { component: 'Domal C-channel', qty: '2*MS', length: 'H-2.75', desc: 'MS C-channel Vertical' },
                    { component: 'Domal C-channel', qty: '2*MS', length: '(W-3+2.5*(S-1))/S', desc: 'MS C-channel Horizontal' },
                    { component: 'Domal Shutter', qty: '2*MS', length: 'H-2.75', desc: 'MS Shutter Vertical' },
                    { component: 'Domal Shutter', qty: '2*MS', length: '(W-3+2.5*(S-1))/S', desc: 'MS Shutter Horizontal' },
                    { component: 'Domal Clip', qty: '1*MS', length: 'H-2.75', desc: 'MS Domal Clip' }
                ],
                '3/4': [
                    // Standard Components
                    { component: '3/4 Handle', qty: '2', length: 'H-1.5', desc: 'Handles' },
                    { component: '3/4 Interlock', qty: '2*S-2', length: 'H-1.5', desc: 'Interlocks' },
                    { component: '3/4 Bearing Bottom', qty: '2*S', length: '(W-5-1.5*(S-1))/S', desc: 'Bearing Bottom' },
                    { component: '3/4 Track Top', qty: '1', length: 'W', desc: 'Track Top' },
                    { component: '3/4 Track Top', qty: '2', length: 'H', desc: 'Track Sides' },
                    { component: '3/4 Track Bottom', qty: '1', length: 'W', desc: 'Track Bottom' },

                    // Mosquito Shutter (MS) Logic - UPDATED
                    { component: '3/4 Handle', qty: '1*MS', length: 'H-1.5', desc: 'MS Handle' },
                    { component: '3/4 Interlock', qty: '1*MS', length: 'H-1.5', desc: 'MS Interlock' },
                    { component: '3/4 Bearing Bottom', qty: '2*MS', length: '(W-5-1.5*(S-1))/S', desc: 'MS Bearing Bottom' },
                    // C-channel logic: 4 pieces per MS (2 vertical same as Handle length, 2 horizontal same as Bearing length)
                    { component: '3/4 C-channel', qty: '2*MS', length: 'H-1.5', desc: 'MS C-channel Vertical' },
                    { component: '3/4 C-channel', qty: '2*MS', length: '(W-5-1.5*(S-1))/S', desc: 'MS C-channel Horizontal' }
                ],
                '1': [
                    // Standard Components
                    { component: '1" Handle', qty: '2', length: 'H-1.125', desc: 'Handles' },
                    { component: '1" Interlock', qty: '2*S-2', length: 'H-1.125', desc: 'Interlocks' },
                    { component: '1" Bearing Bottom', qty: '2*S', length: '(W-5-2*(S-1))/S', desc: 'Bearing Bottom' },
                    { component: '1" Track Top', qty: '1', length: 'W', desc: 'Track Top' },
                    { component: '1" Track Top', qty: '2', length: 'H', desc: 'Track Sides' },
                    { component: '1" Track Bottom', qty: '1', length: 'W', desc: 'Track Bottom' },

                    // Mosquito Shutter (MS) Logic - UPDATED
                    { component: '1" Handle', qty: '1*MS', length: 'H-1.125', desc: 'MS Handle' },
                    { component: '1" Interlock', qty: '1*MS', length: 'H-1.125', desc: 'MS Interlock' },
                    { component: '1" Bearing Bottom', qty: '2*MS', length: '(W-5-2*(S-1))/S', desc: 'MS Bearing Bottom' },
                    // C-channel logic: 4 pieces per MS (2 vertical same as Handle length, 2 horizontal same as Bearing length)
                    { component: '1" C-channel', qty: '2*MS', length: 'H-1.125', desc: 'MS C-channel Vertical' },
                    { component: '1" C-channel', qty: '2*MS', length: '(W-5-2*(S-1))/S', desc: 'MS C-channel Horizontal' }
                ]
            };

            // Stock master with costs
            stockMaster = {
                'Domal': [
                    { material: 'Domal Shutter', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: 'Domal Clip', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: 'Domal Track', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: 'Domal C-channel', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 }
                ],
                '3/4': [
                    { material: '3/4 Handle', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: '3/4 Interlock', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: '3/4 Bearing Bottom', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: '3/4 Track Top', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: '3/4 Track Bottom', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: '3/4 C-channel', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 }
                ],
                '1': [
                    { material: '1" Handle', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: '1" Interlock', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: '1" Bearing Bottom', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: '1" Track Top', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: '1" Track Bottom', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 },
                    { material: '1" C-channel', stock1: 141, stock1Cost: 100, stock2: 177, stock2Cost: 125 }
                ]
            };

            windows = [
                {
                    configId: 'W01',
                    projectName: 'check',
                    width: 65,
                    height: 56,
                    tracks: 3,
                    shutters: 3,
                    mosquitoShutters: 0,
                    series: '3/4',
                    description: 'Living Room Main'
                }
            ];

            refreshAllUI();
        }

        function refreshAllUI() {
            refreshSeriesDropdown();
            refreshFormulasDisplay();
            refreshStockMaster();
            refreshProjectSelector();
            displayWindows();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'windows') displayWindows();
            if (tabName === 'formulas') refreshFormulasDisplay();
            if (tabName === 'stock') refreshStockMaster();
            if (tabName === 'optimize') refreshProjectSelector();
        }

        function refreshSeriesDropdown() {
            const select = document.getElementById('series');
            const editSelect = document.getElementById('editSeries');
            const newStockSelect = document.getElementById('newStockSeries');
            select.innerHTML = '';
            editSelect.innerHTML = '';
            newStockSelect.innerHTML = '';
            Object.keys(seriesFormulas).forEach(series => {
                select.innerHTML += `<option value="${series}">${series} Series</option>`;
                editSelect.innerHTML += `<option value="${series}">${series} Series</option>`;
                newStockSelect.innerHTML += `<option value="${series}">${series} Series</option>`;
            });
        }

        function refreshFormulasDisplay() {
            const container = document.getElementById('formulasList');
            let html = '';
            Object.entries(seriesFormulas).forEach(([series, formulas]) => {
                html += `<div class="formula-card">
                    <h3>${series} Series
                        <button class="btn btn-success btn-sm" style="float: right; margin-left: 10px;" onclick="showAddComponentModal('${series}')">‚ûï Add Component</button>
                        <button class="btn btn-danger btn-sm" style="float: right;" onclick="deleteSeries('${series}')">üóëÔ∏è Delete Series</button>
                    </h3>`;
                formulas.forEach((f, idx) => {
                    html += `<div class="formula-item">
                        <div class="formula-content">
                            <strong>${f.desc}:</strong><br>
                            Component: <code>${f.component}</code><br>
                            Quantity: <code>${f.qty}</code> pieces<br>
                            Length: <code>${f.length}</code> inches
                        </div>
                        <div class="formula-actions">
                            <button class="btn btn-warning btn-sm" onclick="editFormula('${series}', ${idx})">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteFormula('${series}', ${idx})">üóëÔ∏è</button>
                        </div>
                    </div>`;
                });
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function refreshStockMaster() {
            const container = document.getElementById('stockMasterList');
            let html = '';
            Object.entries(stockMaster).forEach(([series, stocks]) => {
                html += `<div class="stock-material-card"><h4>${series} Series Materials</h4>
                    <table><thead><tr><th>Material</th><th>Stock 1 (in)</th><th>Cost (‚Çπ)</th><th>Stock 2 (in)</th><th>Cost (‚Çπ)</th><th>Actions</th></tr></thead><tbody>`;
                stocks.forEach((stock, idx) => {
                    html += `<tr>
                        <td>${stock.material}</td>
                        <td><input type="number" value="${stock.stock1}" onchange="updateStock('${series}', ${idx}, 'stock1', this.value)" style="width: 80px; padding: 5px;"></td>
                        <td><input type="number" value="${stock.stock1Cost}" onchange="updateStock('${series}', ${idx}, 'stock1Cost', this.value)" style="width: 80px; padding: 5px;"></td>
                        <td><input type="number" value="${stock.stock2}" onchange="updateStock('${series}', ${idx}, 'stock2', this.value)" style="width: 80px; padding: 5px;"></td>
                        <td><input type="number" value="${stock.stock2Cost}" onchange="updateStock('${series}', ${idx}, 'stock2Cost', this.value)" style="width: 80px; padding: 5px;"></td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteStock('${series}', ${idx})">üóëÔ∏è</button></td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            });
            container.innerHTML = html;
        }

        function refreshProjectSelector() {
            const select = document.getElementById('projectSelector');
            const projects = [...new Set(windows.map(w => w.projectName))];
            select.innerHTML = '<option value="">-- Select Project --</option>';
            projects.forEach(proj => {
                const count = windows.filter(w => w.projectName === proj).length;
                select.innerHTML += `<option value="${proj}">${proj} (${count} windows)</option>`;
            });
            select.onchange = function() {
                const info = document.getElementById('projectInfo');
                if (this.value) {
                    const count = windows.filter(w => w.projectName === this.value).length;
                    const seriesTypes = [...new Set(windows.filter(w => w.projectName === this.value).map(w => w.series))];
                    info.innerHTML = `<strong>${count}</strong> windows | Series: <strong>${seriesTypes.join(', ')}</strong>`;
                } else {
                    info.innerHTML = 'No project selected';
                }
            };
        }

        function addWindow(event) {
            event.preventDefault();
            const window = {
                configId: document.getElementById('configId').value,
                projectName: document.getElementById('projectName').value,
                width: convertToInches(parseFloat(document.getElementById('width').value)),
                height: convertToInches(parseFloat(document.getElementById('height').value)),
                tracks: parseInt(document.getElementById('tracks').value),
                shutters: parseInt(document.getElementById('shutters').value),
                mosquitoShutters: parseInt(document.getElementById('mosquitoShutters').value),
                series: document.getElementById('series').value,
                description: document.getElementById('description').value
            };
            windows.push(window);
            const lastNum = parseInt(window.configId.substring(1));
            document.getElementById('configId').value = 'W' + String(lastNum + 1).padStart(2, '0');
            alert('‚úÖ Window ' + window.configId + ' added successfully!');
            refreshProjectSelector();
        }

        function clearForm() {
            document.getElementById('windowForm').reset();
            document.getElementById('configId').value = 'W01';
            document.getElementById('projectName').value = 'check';
        }

        function displayWindows() {
            const container = document.getElementById('windowList');
            if (windows.length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 40px;">No windows added yet.</p>';
                return;
            }
            let html = '';
            windows.forEach((w, idx) => {
                html += `<div class="window-card"><div><h3>${w.configId} - ${w.description}</h3>
                        <div class="window-details">
                            <div><strong>Project:</strong> ${w.projectName}</div>
                            <div><strong>Size:</strong> ${w.width}" √ó ${w.height}"</div>
                            <div><strong>Tracks:</strong> ${w.tracks}</div>
                            <div><strong>Shutters:</strong> ${w.shutters}</div>
                            <div><strong>Mosquito Shutters:</strong> ${w.mosquitoShutters}</div>
                            <div><strong>Series:</strong> ${w.series}</div>
                        </div>
                        <div class="window-actions">
                            <button class="btn btn-warning btn-sm" onclick="editWindow(${idx})">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteWindow(${idx})">üóëÔ∏è Delete</button>
                        </div></div></div>`;
            });
            container.innerHTML = html;
        }

        function editWindow(idx) {
            const win = windows[idx];
            document.getElementById('editWindowIndex').value = idx;
            document.getElementById('editConfigId').value = win.configId;
            document.getElementById('editProjectName').value = win.projectName;
            document.getElementById('editWidth').value = win.width;
            document.getElementById('editHeight').value = win.height;
            document.getElementById('editTracks').value = win.tracks;
            document.getElementById('editShutters').value = win.shutters;
            document.getElementById('editMosquitoShutters').value = win.mosquitoShutters;
            document.getElementById('editSeries').value = win.series;
            document.getElementById('editDescription').value = win.description;
            document.getElementById('editWindowModal').classList.add('active');
        }

        function closeEditWindowModal() { document.getElementById('editWindowModal').classList.remove('active'); }

        function saveWindowEdit(event) {
            event.preventDefault();
            const idx = parseInt(document.getElementById('editWindowIndex').value);
            windows[idx] = {
                configId: document.getElementById('editConfigId').value,
                projectName: document.getElementById('editProjectName').value,
                width: convertToInches(parseFloat(document.getElementById('editWidth').value)),
                height: convertToInches(parseFloat(document.getElementById('editHeight').value)),
                tracks: parseInt(document.getElementById('editTracks').value),
                shutters: parseInt(document.getElementById('editShutters').value),
                mosquitoShutters: parseInt(document.getElementById('editMosquitoShutters').value),
                series: document.getElementById('editSeries').value,
                description: document.getElementById('editDescription').value
            };
            closeEditWindowModal();
            displayWindows();
            refreshProjectSelector();
            alert('‚úÖ Window updated successfully!');
        }

        function showAddComponentModal(series) {
            document.getElementById('addComponentSeries').value = series;
            document.getElementById('modalComponentName').value = '';
            document.getElementById('modalComponentQty').value = '';
            document.getElementById('modalComponentLength').value = '';
            document.getElementById('modalComponentDesc').value = '';
            document.getElementById('addComponentModal').classList.add('active');
        }

        function closeAddComponentModal() { document.getElementById('addComponentModal').classList.remove('active'); }

        function saveNewComponent(event) {
            event.preventDefault();
            const series = document.getElementById('addComponentSeries').value;
            const component = document.getElementById('modalComponentName').value;
            const qty = document.getElementById('modalComponentQty').value;
            const length = document.getElementById('modalComponentLength').value;
            const desc = document.getElementById('modalComponentDesc').value;
            if (!seriesFormulas[series]) { seriesFormulas[series] = []; }
            seriesFormulas[series].push({ component: component, qty: qty, length: length, desc: desc });
            closeAddComponentModal();
            refreshFormulasDisplay();
            alert('‚úÖ Component added successfully!');
        }

        function deleteWindow(idx) { if (confirm('Delete this window?')) { windows.splice(idx, 1); displayWindows(); refreshProjectSelector(); } }
        function editFormula(series, idx) {
            const formula = seriesFormulas[series][idx];
            document.getElementById('editFormulaSeries').value = series;
            document.getElementById('editFormulaIndex').value = idx;
            document.getElementById('editFormulaComponent').value = formula.component;
            document.getElementById('editFormulaDesc').value = formula.desc;
            document.getElementById('editFormulaQty').value = formula.qty;
            document.getElementById('editFormulaLength').value = formula.length;
            document.getElementById('editFormulaModal').classList.add('active');
        }
        function closeEditFormulaModal() { document.getElementById('editFormulaModal').classList.remove('active'); }
        function saveFormulaEdit(event) {
            event.preventDefault();
            const series = document.getElementById('editFormulaSeries').value;
            const idx = parseInt(document.getElementById('editFormulaIndex').value);
            seriesFormulas[series][idx] = {
                component: document.getElementById('editFormulaComponent').value,
                desc: document.getElementById('editFormulaDesc').value,
                qty: document.getElementById('editFormulaQty').value,
                length: document.getElementById('editFormulaLength').value
            };
            closeEditFormulaModal();
            refreshFormulasDisplay();
            alert('‚úÖ Formula updated successfully!');
        }
        function addNewSeries(event) {
            event.preventDefault();
            const seriesName = document.getElementById('newSeriesName').value;
            if (!seriesFormulas[seriesName]) { seriesFormulas[seriesName] = []; stockMaster[seriesName] = []; }
            seriesFormulas[seriesName].push({
                component: document.getElementById('newComponentName').value,
                qty: document.getElementById('newQtyFormula').value,
                length: document.getElementById('newLengthFormula').value,
                desc: document.getElementById('newComponentDesc').value
            });
            alert('‚úÖ Component added to ' + seriesName + ' series!');
            document.getElementById('newSeriesForm').reset();
            refreshAllUI();
        }
        function deleteSeries(series) { if (confirm('Delete entire ' + series + ' series?')) { delete seriesFormulas[series]; delete stockMaster[series]; refreshAllUI(); } }
        function deleteFormula(series, idx) { if (confirm('Delete this formula?')) { seriesFormulas[series].splice(idx, 1); refreshFormulasDisplay(); } }
        function addNewStock(event) {
            event.preventDefault();
            const series = document.getElementById('newStockSeries').value;
            if (!stockMaster[series]) { stockMaster[series] = []; }
            stockMaster[series].push({
                material: document.getElementById('newStockMaterial').value,
                stock1: parseFloat(document.getElementById('newStock1').value),
                stock1Cost: parseFloat(document.getElementById('newStock1Cost').value),
                stock2: parseFloat(document.getElementById('newStock2').value),
                stock2Cost: parseFloat(document.getElementById('newStock2Cost').value)
            });
            alert('‚úÖ Stock material added!');
            document.getElementById('newStockForm').reset();
            refreshStockMaster();
        }
        function updateStock(series, idx, field, value) { stockMaster[series][idx][field] = parseFloat(value); }
        function deleteStock(series, idx) { if (confirm('Delete this stock material?')) { stockMaster[series].splice(idx, 1); refreshStockMaster(); } }
        function updateKerf() { kerf = parseFloat(document.getElementById('kerfGlobal').value); }

        // [Calculation & Optimization Functions]
        function calculatePieces(selectedProject) {
            const pieces = {};
            const projectWindows = windows.filter(w => w.projectName === selectedProject);
            projectWindows.forEach(win => {
                const W = win.width;
                const H = win.height;
                const S = win.shutters;
                const MS = win.mosquitoShutters;
                const T = win.tracks;
                const id = win.configId;
                const formulas = seriesFormulas[win.series];
                if (!formulas) return;
                formulas.forEach(formula => {
                    try {
                        let qtyVal = eval(formula.qty);
                        let lenVal = eval(formula.length);
                        const qty = parseInt(qtyVal, 10);
                        const length = parseFloat(lenVal);
                        if (qty > 0 && length > 0) {
                            addPieces(pieces, formula.component, length, id + ' - ' + formula.desc, qty);
                        }
                    } catch (e) { console.error('Formula error:', e, formula); }
                });
            });
            return pieces;
        }

        function addPieces(pieces, material, length, label, qty) {
            if (!pieces[material]) { pieces[material] = []; }
            for (let i = 0; i < qty; i++) { pieces[material].push({ length: length, label: label }); }
        }

        function runOptimization() {
            const selectedProject = document.getElementById('projectSelector').value;
            if (!selectedProject) { alert('‚ùå Please select a project first!'); return; }
            const piecesByMaterial = calculatePieces(selectedProject);
            if (Object.keys(piecesByMaterial).length === 0) { alert('‚ùå No pieces calculated for this project!'); return; }
            const results = {};
            let totalSticks = 0; let totalUsed = 0; let totalWaste = 0; let totalCost = 0;
            for (const [material, pieces] of Object.entries(piecesByMaterial)) {
                const projectSeries = windows.find(w => w.projectName === selectedProject).series;
                const stockInfo = stockMaster[projectSeries].find(s => s.material === material);
                if (!stockInfo) { console.warn('No stock info for:', material); continue; }
                const plans = optimizeMaterialSmart(pieces, stockInfo, kerf);
                results[material] = plans;
                plans.forEach(plan => {
                    totalSticks++; totalUsed += plan.used; totalWaste += plan.waste; totalCost += plan.cost;
                });
            }
            optimizationResults = { project: selectedProject, results: results, stats: { totalSticks: totalSticks, totalUsed: totalUsed.toFixed(2), totalWaste: totalWaste.toFixed(2), totalCost: totalCost.toFixed(0), efficiency: ((totalUsed / (totalUsed + totalWaste)) * 100).toFixed(1) }, config: { kerf } };
            displayResults();
            showTab('results');
            document.querySelectorAll('.tab')[5].classList.add('active');
        }

        // UPDATED: Runs multiple strategies and picks the one with the Lowest Total Cost
        function optimizeMaterialSmart(pieces, stockInfo, kerf) {
            // Sort pieces largest to smallest for better packing
            pieces.sort((a, b) => b.length - a.length);

            const strategies = [];

            // Strategy 1: Try using ONLY Stock 1 (Force 141")
            strategies.push(solveSpecificStock(pieces, stockInfo.stock1, stockInfo.stock1Cost, kerf));

            // Strategy 2: Try using ONLY Stock 2 (Force 177") - if valid
            if (stockInfo.stock2 && stockInfo.stock2 !== stockInfo.stock1) {
                strategies.push(solveSpecificStock(pieces, stockInfo.stock2, stockInfo.stock2Cost, kerf));
            }

            // Strategy 3: Smart Cost Focused (The mixed approach)
            strategies.push(optimizeCostFocused(pieces, stockInfo, kerf));

            // Strategy 4: Greedy Efficiency (Original approach - sometimes finds better packing)
            strategies.push(optimizeGreedy(pieces, stockInfo, kerf));

            // COMPARE: Find the strategy with the lowest Total Cost
            let bestPlan = null;
            let minCost = Infinity;

            strategies.forEach(plan => {
                const currentCost = plan.reduce((sum, stick) => sum + stick.cost, 0);
                
                // If costs are equal, prefer the one with fewer sticks (less handling)
                if (currentCost < minCost) {
                    minCost = currentCost;
                    bestPlan = plan;
                } else if (Math.abs(currentCost - minCost) < 0.01) {
                    // Tie-breaker: fewer sticks?
                    if (plan.length < bestPlan.length) {
                        bestPlan = plan;
                    }
                }
            });

            return bestPlan;
        }

        // NEW HELPER: Solves the list using only ONE type of stock size
        function solveSpecificStock(pieces, stockLength, stockCost, kerf) {
            const plan = [];
            // Create a shallow copy so we don't mess up the original array
            const remaining = [...pieces]; 

            while (remaining.length > 0) {
                const pattern = findBestPattern(remaining, stockLength, kerf);
                
                if (pattern.pieces.length === 0) {
                    // Should not happen if stock is long enough, but safety check
                    break;
                }

                // Remove used pieces from remaining list
                pattern.pieces.forEach(p => {
                    const idx = remaining.indexOf(p);
                    if (idx !== -1) remaining.splice(idx, 1);
                });

                plan.push({
                    stock: stockLength + '"',
                    pieces: pattern.pieces,
                    used: pattern.used,
                    waste: pattern.waste,
                    cost: stockCost,
                    efficiency: ((pattern.used / stockLength) * 100).toFixed(1)
                });
            }
            return plan;
        }

        function optimizeGreedy(pieces, stockInfo, kerf) {
            const plans = [];
            const remaining = [...pieces];
            while (remaining.length > 0) {
                const strategies = [];
                const fillStock1 = findBestPattern(remaining, stockInfo.stock1, kerf);
                if (fillStock1.pieces.length > 0) { strategies.push({ pattern: fillStock1, stock: stockInfo.stock1, cost: stockInfo.stock1Cost, efficiency: fillStock1.used / stockInfo.stock1, costPerInch: stockInfo.stock1Cost / fillStock1.used }); }
                const fillStock2 = findBestPattern(remaining, stockInfo.stock2, kerf);
                if (fillStock2.pieces.length > 0) { strategies.push({ pattern: fillStock2, stock: stockInfo.stock2, cost: stockInfo.stock2Cost, efficiency: fillStock2.used / stockInfo.stock2, costPerInch: stockInfo.stock2Cost / fillStock2.used }); }
                if (strategies.length === 0) break;
                strategies.sort((a, b) => {
                    if (a.efficiency >= 0.7 && b.efficiency < 0.7) return -1;
                    if (b.efficiency >= 0.7 && a.efficiency < 0.7) return 1;
                    if (Math.abs(a.costPerInch - b.costPerInch) > 0.01) { return a.costPerInch - b.costPerInch; }
                    return a.pattern.waste - b.pattern.waste;
                });
                const bestStrategy = strategies[0];
                bestStrategy.pattern.pieces.forEach(p => { const idx = remaining.findIndex(r => r.length === p.length && r.label === p.label); if (idx !== -1) remaining.splice(idx, 1); });
                plans.push({ stock: bestStrategy.stock + '"', pieces: bestStrategy.pattern.pieces, used: bestStrategy.pattern.used, waste: bestStrategy.pattern.waste, cost: bestStrategy.cost, efficiency: (bestStrategy.efficiency * 100).toFixed(1) });
            }
            return plans;
        }

        function optimizeCostFocused(pieces, stockInfo, kerf) {
            const plans = [];
            const remaining = [...pieces];
            while (remaining.length > 0) {
                const scenarios = [];
                const s1Result = findBestPattern(remaining, stockInfo.stock1, kerf);
                if (s1Result.pieces.length > 0) {
                    const s1Remaining = remaining.filter(r => !s1Result.pieces.includes(r));
                    scenarios.push({ firstCut: { pattern: s1Result, stock: stockInfo.stock1, cost: stockInfo.stock1Cost }, remaining: s1Remaining, twoStocks: false });
                }
                const s2Result = findBestPattern(remaining, stockInfo.stock2, kerf);
                if (s2Result.pieces.length > 0) {
                    const s2Remaining = remaining.filter(r => !s2Result.pieces.includes(r));
                    scenarios.push({ firstCut: { pattern: s2Result, stock: stockInfo.stock2, cost: stockInfo.stock2Cost }, remaining: s2Remaining, twoStocks: false });
                }
                if (stockInfo.stock1 < stockInfo.stock2) {
                    const firstStock1 = findBestPattern(remaining, stockInfo.stock1, kerf);
                    if (firstStock1.pieces.length > 0) {
                        const temp1Remaining = remaining.filter(r => !firstStock1.pieces.includes(r));
                        const secondStock1 = findBestPattern(temp1Remaining, stockInfo.stock1, kerf);
                        if (secondStock1.pieces.length > 0) {
                            const totalCost = stockInfo.stock1Cost * 2;
                            const totalUsed = firstStock1.used + secondStock1.used;
                            const finalRemaining = temp1Remaining.filter(r => !secondStock1.pieces.includes(r));
                            const avgEfficiency = totalUsed / (stockInfo.stock1 * 2);
                            if (avgEfficiency > 0.5) { scenarios.push({ twoStocks: true, cuts: [ { pattern: firstStock1, stock: stockInfo.stock1, cost: stockInfo.stock1Cost }, { pattern: secondStock1, stock: stockInfo.stock1, cost: stockInfo.stock1Cost } ], totalCost: totalCost, avgEfficiency: avgEfficiency, remaining: finalRemaining }); }
                        }
                    }
                }
                if (scenarios.length === 0) break;
                let bestScenario = null; let bestScore = Infinity;
                scenarios.forEach(scenario => {
                    let cost, efficiency;
                    if (scenario.twoStocks) { cost = scenario.totalCost; efficiency = scenario.avgEfficiency; } else { cost = scenario.firstCut.cost; efficiency = scenario.firstCut.pattern.used / scenario.firstCut.stock; }
                    let score = cost; if (efficiency < 0.5) score *= 1.5; if (efficiency < 0.3) score *= 2.0;
                    if (score < bestScore) { bestScore = score; bestScenario = scenario; }
                });
                if (bestScenario.twoStocks) {
                    bestScenario.cuts.forEach(cut => { plans.push({ stock: cut.stock + '"', pieces: cut.pattern.pieces, used: cut.pattern.used, waste: cut.pattern.waste, cost: cut.cost, efficiency: ((cut.pattern.used / cut.stock) * 100).toFixed(1) }); });
                    remaining.length = 0; remaining.push(...bestScenario.remaining);
                } else {
                    const cut = bestScenario.firstCut;
                    plans.push({ stock: cut.stock + '"', pieces: cut.pattern.pieces, used: cut.pattern.used, waste: cut.pattern.waste, cost: cut.cost, efficiency: ((cut.pattern.used / cut.stock) * 100).toFixed(1) });
                    remaining.length = 0; remaining.push(...bestScenario.remaining);
                }
            }
            return plans;
        }

        function findBestPattern(pieces, stockLen, kerf) {
            let bestPattern = { pieces: [], used: 0, waste: stockLen };
            let used = 0; let pattern = [];
            for (const piece of pieces) {
                const needed = piece.length + (pattern.length > 0 ? kerf : 0);
                if (used + needed <= stockLen) { pattern.push(piece); used += needed; }
            }
            if (used > bestPattern.used) { bestPattern = { pieces: pattern, used: used, waste: stockLen - used }; }
            return bestPattern;
        }

        // [Display & Export Functions - Same as before]
        function displayResults() {
            const container = document.getElementById('resultsContent');
            if (!optimizationResults) { container.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 40px">No results yet</p>'; return; }
            const r = optimizationResults;
            let html = '<div class="alert alert-success">Smart Cost-Optimized Results for Project <strong>' + r.project + '</strong></div>';
            html += `
            <div class="import-export-section">
                <div style="text-align: center; margin-bottom: 15px;"><strong style="font-size: 16px;">üì¶ Project Management</strong></div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button class="btn btn-primary" onclick="exportProject()">üíæ Export Project (JSON)</button>
                    <button class="btn btn-primary" onclick="importProject()">üìÇ Import Project (JSON)</button>
                    <button class="btn btn-success" onclick="exportFullResultsExcel()">üìä Export Excel</button>
                    <button class="btn btn-danger" onclick="exportFullResultsPDF()">üìÑ Export PDF</button>
                </div>
            </div>
            <div class="import-export-section">
                <div style="text-align: center; margin-bottom: 15px;"><strong style="font-size: 16px;">üì§ Share Results</strong></div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button class="btn btn-success" onclick="shareViaWhatsApp()">üì± Share via WhatsApp</button>
                    <button class="btn btn-primary" onclick="shareViaEmail()">‚úâÔ∏è Share via Email</button>
                    <button class="btn btn-warning" onclick="generatePrintableLabels()">üè∑Ô∏è Print Labels (A4)</button>
                </div>
            </div>`;
            const materialCost = parseFloat(r.stats.totalCost || 0);
            const wastePercentage = parseFloat(r.stats.totalWaste || 0) / (parseFloat(r.stats.totalUsed || 1) + parseFloat(r.stats.totalWaste || 0));
            const wasteCost = (materialCost * wastePercentage).toFixed(0);
            const usedCost = (materialCost - wasteCost).toFixed(0);
            html += `<div class="cost-breakdown-card"><h3 style="margin-top: 0;">üí∞ Cost Breakdown</h3><div class="cost-breakdown-row"><span>Material (Used)</span><span><strong>‚Çπ${usedCost}</strong></span></div><div class="cost-breakdown-row"><span>Material (Waste)</span><span><strong>‚Çπ${wasteCost}</strong></span></div><div class="cost-breakdown-row" style="border-bottom: 2px solid white; font-size: 18px;"><span><strong>Total Cost</strong></span><span><strong>‚Çπ${r.stats.totalCost}</strong></span></div></div>`;
            html += '<div class="stats-grid">';
            html += '<div class="stat-card"><h4>Total Sticks</h4><p>' + r.stats.totalSticks + '</p></div>';
            html += '<div class="stat-card"><h4>Used Length</h4><p>' + r.stats.totalUsed + '"</p></div>';
            html += '<div class="stat-card"><h4>Waste Length</h4><p>' + r.stats.totalWaste + '"</p></div>';
            html += '<div class="stat-card"><h4>Efficiency</h4><p>' + r.stats.efficiency + '%</p></div>';
            html += '</div>';
            for (const [material, plans] of Object.entries(r.results)) {
                const materialUsed = plans.reduce((sum, p) => sum + p.used, 0);
                const materialWaste = plans.reduce((sum, p) => sum + p.waste, 0);
                const materialTotal = materialUsed + materialWaste;
                const materialEfficiency = ((materialUsed / materialTotal) * 100).toFixed(2);
                const stockCounts = {};
                plans.forEach(plan => { const stockSize = plan.stock.replace('"', ''); stockCounts[stockSize] = (stockCounts[stockSize] || 0) + 1; });
                const requirementStr = Object.entries(stockCounts).map(([size, count]) => size + '" - ' + count + ' nos').join(', ');
                html += '<div class="material-section">';
                html += '<h3>üìè ' + material + '</h3>';
                html += `<div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4caf50"><strong style="font-size: 15px; color: #2e7d32">Material Summary</strong><br><div style="margin-top: 8px; font-size: 14px; line-height: 1.8"><strong>Requirements:</strong> ${requirementStr}<br><strong>Total Used Length:</strong> ${materialUsed.toFixed(2)}" <strong>Total Waste:</strong> ${materialWaste.toFixed(2)}" <strong>Efficiency:</strong> ${materialEfficiency}%</div></div>`;
                html += '<table><thead><tr><th>Stick #</th><th>Stock</th><th>Cut Sequence</th><th>Pieces</th><th>Used</th><th>Waste</th><th>Efficiency</th><th>Cost</th></tr></thead><tbody>';
                let cutNumber = 1;
                plans.forEach((plan, idx) => {
                    const piecesStr = plan.pieces.map(p => p.length.toFixed(2) + '" (' + p.label + ')').join(', ');
                    const cutSequence = plan.pieces.map(() => '#' + (cutNumber++)).join(', ');
                    html += '<tr><td>' + (idx + 1) + '</td><td>' + plan.stock + '</td><td><strong>' + cutSequence + '</strong></td><td>' + piecesStr + '</td><td>' + plan.used.toFixed(2) + '"</td><td>' + plan.waste.toFixed(2) + '"</td><td>' + plan.efficiency + '%</td><td>‚Çπ' + plan.cost + '</td></tr>';
                    const stockLength = parseFloat(plan.stock.replace('"', ''));
                    const diagram = generateCuttingDiagram(plan, stockLength);
                    html += '<tr><td colspan="8"><div class="cutting-diagram">' + diagram + '</div></td></tr>';
                });
                html += '</tbody></table></div>';
            }
            container.innerHTML = html;
        }

        function generateCuttingDiagram(plan, maxLength) {
            const svgWidth = 800; const svgHeight = 60; const scale = svgWidth / maxLength;
            let svg = `<svg width="${svgWidth}" height="${svgHeight}" style="border: 1px solid #ddd; background: white;">`;
            svg += `<rect x="0" y="10" width="${maxLength * scale}" height="40" fill="#ecf0f1" stroke="#95a5a6" stroke-width="2"/>`;
            let currentX = 0;
            const colors = ['#3498db', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];
            plan.pieces.forEach((piece, idx) => {
                const pieceWidth = piece.length * scale;
                const color = colors[idx % colors.length];
                svg += `<rect x="${currentX}" y="10" width="${pieceWidth}" height="40" fill="${color}" opacity="0.7" stroke="white" stroke-width="1"/>`;
                const label = `${piece.length.toFixed(1)}"`;
                const windowId = piece.label.split(' - ')[0];
                svg += `<text x="${currentX + pieceWidth/2}" y="25" font-size="10" fill="white" text-anchor="middle" font-weight="bold">${windowId}</text>`;
                svg += `<text x="${currentX + pieceWidth/2}" y="40" font-size="9" fill="white" text-anchor="middle">${label}</text>`;
                currentX += pieceWidth;
                if (idx < plan.pieces.length - 1) { svg += `<rect x="${currentX}" y="10" width="${kerf * scale}" height="40" fill="#e74c3c"/>`; currentX += kerf * scale; }
            });
            if (plan.waste > 0) { const wasteWidth = plan.waste * scale; svg += `<rect x="${currentX}" y="10" width="${wasteWidth}" height="40" fill="#95a5a6" opacity="0.5"/>`; svg += `<text x="${currentX + wasteWidth/2}" y="35" font-size="10" fill="#2c3e50" text-anchor="middle">Waste: ${plan.waste.toFixed(1)}"</text>`; }
            svg += '</svg>';
            return svg;
        }

        // [Export Helper Functions - Keeping previous implementations]
        function exportProject() {
            const projectData = { version: '1.0', exportDate: new Date().toISOString(), windows: windows, seriesFormulas: seriesFormulas, stockMaster: stockMaster, kerf: kerf, unitMode: unitMode };
            const dataStr = JSON.stringify(projectData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url; link.download = `Niruma_Project_${new Date().toISOString().split('T')[0]}.json`;
            link.click(); URL.revokeObjectURL(url);
            alert('Project exported successfully!');
        }

        function importProject() {
            const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const projectData = JSON.parse(event.target.result);
                        if (!projectData.windows || !projectData.seriesFormulas || !projectData.stockMaster) throw new Error('Invalid project file format');
                        windows = projectData.windows; seriesFormulas = projectData.seriesFormulas; stockMaster = projectData.stockMaster; kerf = projectData.kerf || 0.125; unitMode = projectData.unitMode || 'inch';
                        document.getElementById('kerfGlobal').value = kerf; document.getElementById('unitToggle').checked = (unitMode === 'mm');
                        refreshAllUI(); alert(`Project imported successfully!\n${windows.length} windows loaded.`);
                    } catch (error) { alert('Error importing project: ' + error.message); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function shareViaWhatsApp() {
            if (!optimizationResults) { alert('Please run optimization first!'); return; }
            const r = optimizationResults;
            let message = `*Niruma Aluminum Profile Optimizer*\n*Project:* ${r.project}\n\n*SUMMARY*\nTotal Sticks: ${r.stats.totalSticks}\nTotal Cost: ‚Çπ${r.stats.totalCost}\nEfficiency: ${r.stats.efficiency}%\n\n*PURCHASE LIST*\n`;
            for (const [material, plans] of Object.entries(r.results)) {
                const stockCounts = {};
                plans.forEach(plan => { const stockSize = plan.stock.replace('"', ''); stockCounts[stockSize] = (stockCounts[stockSize] || 0) + 1; });
                message += `\n${material}:\n`;
                for (const [size, count] of Object.entries(stockCounts)) { message += `  ‚Ä¢ ${size}" - ${count} nos\n`; }
            }
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        function shareViaEmail() {
            if (!optimizationResults) { alert('Please run optimization first!'); return; }
            const r = optimizationResults;
            let body = `NIRUMA ALUMINUM PROFILE OPTIMIZER\nProject: ${r.project}\n\nSUMMARY\nTotal Sticks: ${r.stats.totalSticks}\nTotal Cost: ‚Çπ${r.stats.totalCost}\nEfficiency: ${r.stats.efficiency}%\n\nPURCHASE LIST\n`;
            for (const [material, plans] of Object.entries(r.results)) {
                const stockCounts = {};
                plans.forEach(plan => { const stockSize = plan.stock.replace('"', ''); stockCounts[stockSize] = (stockCounts[stockSize] || 0) + 1; });
                body += `\n${material}:\n`;
                for (const [size, count] of Object.entries(stockCounts)) { body += `  ${size}" - ${count} nos\n`; }
            }
            window.location.href = `mailto:?subject=${encodeURIComponent('Niruma Cutting Plan - ' + r.project)}&body=${encodeURIComponent(body)}`;
        }

        function generatePrintableLabels() {
            if (!optimizationResults) { alert('Please run optimization first!'); return; }
            const r = optimizationResults;
            let labelHTML = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Cutting Labels - ${r.project}</title><style>@page { size: A4; margin: 10mm; } body { font-family: 'Courier New', monospace; } .label-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5mm; padding: 0; } .label-item { border: 2px solid #000; padding: 3mm; height: 25mm; display: flex; flex-direction: column; justify-content: center; font-size: 10pt; page-break-inside: avoid; } .label-header { font-weight: bold; font-size: 12pt; border-bottom: 1px solid #000; margin-bottom: 2mm; } @media print { .no-print { display: none; } }</style></head><body><div class="no-print" style="text-align: center; padding: 20px;"><h2>Niruma Labels</h2><button onclick="window.print()">Print Labels</button></div><div class="label-grid">`;
            for (const [material, plans] of Object.entries(r.results)) {
                let cutNumber = 1;
                plans.forEach((plan, stickIdx) => {
                    plan.pieces.forEach(piece => {
                        const windowId = piece.label.split(' - ')[0];
                        labelHTML += `<div class="label-item"><div class="label-header">${r.project}</div><div><strong>Window:</strong> ${windowId}</div><div><strong>Material:</strong> ${material}</div><div><strong>Cut #:</strong> ${cutNumber}</div><div><strong>Length:</strong> ${piece.length.toFixed(2)}"</div></div>`;
                        cutNumber++;
                    });
                });
            }
            labelHTML += `</div></body></html>`;
            const printWindow = window.open('', '_blank'); printWindow.document.write(labelHTML); printWindow.document.close();
        }

        function exportFullResultsExcel() {
            if (!optimizationResults) { alert('No results to export!'); return; }
            const r = optimizationResults;
            const wb = XLSX.utils.book_new();
            const summaryData = [['Niruma Aluminum Profile Optimizer'], ['Project:', r.project], [''], ['Overall Statistics'], ['Total Sticks', r.stats.totalSticks], ['Total Used Length', r.stats.totalUsed + '"'], ['Total Waste Length', r.stats.totalWaste + '"'], ['Overall Efficiency', r.stats.efficiency + '%'], ['Total Cost', '‚Çπ' + r.stats.totalCost], ['']];
            for (const [material, plans] of Object.entries(r.results)) {
                const materialUsed = plans.reduce((sum, p) => sum + p.used, 0);
                const materialWaste = plans.reduce((sum, p) => sum + p.waste, 0);
                const materialTotal = materialUsed + materialWaste;
                const materialEfficiency = ((materialUsed / materialTotal) * 100).toFixed(2);
                const stockCounts = {};
                plans.forEach(plan => { const stockSize = plan.stock.replace('"', ''); stockCounts[stockSize] = (stockCounts[stockSize] || 0) + 1; });
                const requirementStr = Object.entries(stockCounts).map(([size, count]) => `${size}" - ${count} nos`).join(' | ');
                summaryData.push([`Material: ${material}`]); summaryData.push(['Requirements', requirementStr]); summaryData.push(['Used Length', materialUsed.toFixed(2) + '"']); summaryData.push(['Waste Length', materialWaste.toFixed(2) + '"']); summaryData.push(['Efficiency', materialEfficiency + '%']); summaryData.push(['']);
                summaryData.push(['Detailed Cutting Plan']); summaryData.push(['Stick #', 'Stock', 'Pieces', 'Used', 'Waste', 'Efficiency', 'Cost']);
                plans.forEach((plan, idx) => {
                    const piecesStr = plan.pieces.map(p => `${p.length.toFixed(2)}" (${p.label})`).join(' | ');
                    summaryData.push([idx + 1, plan.stock, piecesStr, plan.used.toFixed(2) + '"', plan.waste.toFixed(2) + '"', plan.efficiency + '%', '‚Çπ' + plan.cost]);
                });
                summaryData.push(['']);
            }
            const ws = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws, 'Full Results');
            XLSX.writeFile(wb, `${r.project}_Full_Results.xlsx`);
        }

        function exportFullResultsPDF() {
            if (!optimizationResults) { alert('No results to export!'); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const r = optimizationResults;
            doc.setFontSize(18); doc.text('Niruma Aluminum Profile Optimizer', 14, 20);
            doc.setFontSize(12); doc.text(`Project: ${r.project}`, 14, 30);
            doc.setFontSize(14); doc.text('Overall Statistics', 14, 45);
            doc.autoTable({ startY: 50, head: [['Metric', 'Value']], body: [['Total Sticks', r.stats.totalSticks], ['Total Used Length', r.stats.totalUsed + '"'], ['Total Waste Length', r.stats.totalWaste + '"'], ['Overall Efficiency', r.stats.efficiency + '%'], ['Total Cost', '‚Çπ' + r.stats.totalCost]], theme: 'grid', headStyles: { fillColor: [52, 152, 219] } });
            let currentY = doc.lastAutoTable.finalY + 10;
            for (const [material, plans] of Object.entries(r.results)) {
                if (currentY > 250) { doc.addPage(); currentY = 20; }
                const materialUsed = plans.reduce((sum, p) => sum + p.used, 0);
                const materialWaste = plans.reduce((sum, p) => sum + p.waste, 0);
                const materialTotal = materialUsed + materialWaste;
                const materialEfficiency = ((materialUsed / materialTotal) * 100).toFixed(2);
                const stockCounts = {};
                plans.forEach(plan => { const stockSize = plan.stock.replace('"', ''); stockCounts[stockSize] = (stockCounts[stockSize] || 0) + 1; });
                const requirementStr = Object.entries(stockCounts).map(([size, count]) => `${size}" - ${count} nos`).join(' | ');
                doc.setFontSize(14); doc.text(`Material: ${material}`, 14, currentY); currentY += 7;
                doc.setFontSize(10); doc.text(`Requirements: ${requirementStr}`, 14, currentY); currentY += 5;
                doc.text(`Used: ${materialUsed.toFixed(2)}" | Waste: ${materialWaste.toFixed(2)}" | Efficiency: ${materialEfficiency}%`, 14, currentY); currentY += 10;
                const tableData = plans.map((plan, idx) => { const piecesStr = plan.pieces.map(p => `${p.length.toFixed(2)}" (${p.label})`).join(' | '); return [idx + 1, plan.stock, piecesStr, plan.used.toFixed(2) + '"', plan.waste.toFixed(2) + '"', plan.efficiency + '%', '‚Çπ' + plan.cost]; });
                doc.autoTable({ startY: currentY, head: [['#', 'Stock', 'Pieces', 'Used', 'Waste', 'Eff%', 'Cost']], body: tableData, theme: 'striped', headStyles: { fillColor: [46, 125, 50] }, styles: { fontSize: 8 } });
                currentY = doc.lastAutoTable.finalY + 10;
            }
            doc.save(`${r.project}_Full_Results.pdf`);
        }

        window.onload = initializeDefaults;
    </script>
</body>

</html>
